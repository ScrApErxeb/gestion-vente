{% extends "base.html" %}

{% block title %}Produits - GestioStock{% endblock %}

{% block content %}
<div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>üì¶ Gestion des Produits</h1>
            <p>Liste compl√®te de vos produits en stock</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="exporterProduits()">
                üì• Exporter Excel
            </button>
            <button class="btn btn-primary" onclick="toggleModal('modal-produit')">
                ‚ûï Nouveau Produit
            </button>
        </div>
    </div>
</div>

<!-- Filtres -->
<div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
    <div class="form-row">
        <div class="form-group" style="margin: 0;">
            <input type="text" id="search-produit" placeholder="üîç Rechercher par nom, r√©f√©rence...">
        </div>
        <div class="form-group" style="margin: 0;">
            <select id="filter-categorie" onchange="filtrerProduits()">
                <option value="">Toutes les cat√©gories</option>
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <select id="filter-stock" onchange="filtrerProduits()">
                <option value="">Tous les stocks</option>
                <option value="faible">Stock faible uniquement</option>
            </select>
        </div>
    </div>
</div>

<!-- Table des produits -->
<div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
    <table id="produits-table">
        <thead>
            <tr>
                <th>R√©f√©rence</th>
                <th>Nom</th>
                <th>Cat√©gorie</th>
                <th>Prix Achat</th>
                <th>Prix Vente</th>
                <th>Stock</th>
                <th>Valeur</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal Nouveau/Modifier Produit -->
<div id="modal-produit" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-produit-title">Nouveau Produit</h2>
            <span class="modal-close" onclick="toggleModal('modal-produit')">&times;</span>
        </div>
        <form id="form-produit" onsubmit="saveProduit(event)">
            <input type="hidden" id="produit-id" name="id">
            
            <div class="form-row">
                <div class="form-group">
                    <label>R√©f√©rence *</label>
                    <input type="text" name="reference" id="produit-reference" required>
                </div>
                <div class="form-group">
                    <label>Code-barres</label>
                    <input type="text" name="code_barre" id="produit-code-barre">
                </div>
            </div>
            
            <div class="form-group">
                <label>Nom du produit *</label>
                <input type="text" name="nom" id="produit-nom" required>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" id="produit-description" rows="3"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Cat√©gorie</label>
                    <select name="categorie_id" id="produit-categorie"></select>
                </div>
                <div class="form-group">
                    <label>Fournisseur</label>
                    <select name="fournisseur_id" id="produit-fournisseur"></select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Prix d'achat *</label>
                    <input type="number" name="prix_achat" id="produit-prix-achat" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Prix de vente *</label>
                    <input type="number" name="prix_vente" id="produit-prix-vente" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>TVA (%)</label>
                    <input type="number" name="tva" id="produit-tva" step="0.01" value="18">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Stock actuel</label>
                    <input type="number" name="stock_actuel" id="produit-stock-actuel" value="0">
                </div>
                <div class="form-group">
                    <label>Stock minimum</label>
                    <input type="number" name="stock_min" id="produit-stock-min" value="0">
                </div>
                <div class="form-group">
                    <label>Stock maximum</label>
                    <input type="number" name="stock_max" id="produit-stock-max" value="1000">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Unit√© de mesure</label>
                    <select name="unite_mesure" id="produit-unite">
                        <option value="unit√©">Unit√©</option>
                        <option value="pi√®ce">Pi√®ce</option>
                        <option value="kg">Kilogramme</option>
                        <option value="litre">Litre</option>
                        <option value="m√®tre">M√®tre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Emplacement</label>
                    <input type="text" name="emplacement" id="produit-emplacement" placeholder="Ex: Rayon A-1">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="toggleModal('modal-produit')">‚ùå Annuler</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let produits = [];
    
    async function loadProduits() {
        try {
            const search = document.getElementById('search-produit').value;
            const categorie = document.getElementById('filter-categorie').value;
            const stockFaible = document.getElementById('filter-stock').value;
            
            let url = '/api/produits?';
            if (search) url += `search=${search}&`;
            if (categorie) url += `categorie_id=${categorie}&`;
            if (stockFaible) url += `stock_faible=true&`;
            
            const response = await fetch(url);
            produits = await response.json();
            
            afficherProduits(produits);
        } catch (error) {
            console.error('Erreur:', error);
        }
    }
    
    function afficherProduits(data) {
        const tbody = document.querySelector('#produits-table tbody');
        tbody.innerHTML = data.map(p => `
            <tr>
                <td><strong>${p.reference}</strong></td>
                <td>${p.nom}</td>
                <td>${p.categorie || '-'}</td>
                <td>${formatCurrency(p.prix_achat)}</td>
                <td>${formatCurrency(p.prix_vente)}</td>
                <td><strong>${p.stock_actuel}</strong> ${p.unite_mesure}</td>
                <td>${formatCurrency(p.valeur_stock)}</td>
                <td>
                    ${p.stock_faible ? 
                        '<span class="badge badge-danger">‚ö†Ô∏è Stock faible</span>' : 
                        '<span class="badge badge-success">‚úÖ OK</span>'}
                </td>
                <td>
                    <button class="btn btn-secondary btn-sm" onclick="editProduit(${p.id})" title="Modifier">‚úèÔ∏è</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduit(${p.id})" title="Supprimer">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
    }
    
    async function loadCategories() {
        const response = await fetch('/api/categories');
        const categories = await response.json();
        
        const selects = ['filter-categorie', 'produit-categorie'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">S√©lectionner...</option>' +
                categories.map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
        });
    }
    
    async function loadFournisseurs() {
        const response = await fetch('/api/fournisseurs');
        const fournisseurs = await response.json();
        
        const select = document.getElementById('produit-fournisseur');
        select.innerHTML = '<option value="">S√©lectionner...</option>' +
            fournisseurs.map(f => `<option value="${f.id}">${f.nom}</option>`).join('');
    }
    
    async function saveProduit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        // Convertir les nombres
        ['prix_achat', 'prix_vente', 'tva', 'stock_actuel', 'stock_min', 'stock_max'].forEach(key => {
            if (data[key]) data[key] = parseFloat(data[key]);
        });
        ['categorie_id', 'fournisseur_id'].forEach(key => {
            if (data[key]) data[key] = parseInt(data[key]);
        });
        
        const id = document.getElementById('produit-id').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/produits/${id}` : '/api/produits';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                toggleModal('modal-produit');
                form.reset();
                loadProduits();
                alert('‚úÖ Produit enregistr√© avec succ√®s!');
            } else {
                const error = await response.json();
                alert('‚ùå Erreur: ' + (error.error || 'Erreur inconnue'));
            }
        } catch (error) {
            alert('‚ùå Erreur de connexion');
        }
    }
    
    function editProduit(id) {
        const produit = produits.find(p => p.id === id);
        if (!produit) return;
        
        document.getElementById('modal-produit-title').textContent = 'Modifier le produit';
        document.getElementById('produit-id').value = produit.id;
        document.getElementById('produit-reference').value = produit.reference;
        document.getElementById('produit-code-barre').value = produit.code_barre || '';
        document.getElementById('produit-nom').value = produit.nom;
        document.getElementById('produit-description').value = produit.description || '';
        document.getElementById('produit-prix-achat').value = produit.prix_achat;
        document.getElementById('produit-prix-vente').value = produit.prix_vente;
        document.getElementById('produit-tva').value = produit.tva;
        document.getElementById('produit-stock-actuel').value = produit.stock_actuel;
        document.getElementById('produit-stock-min').value = produit.stock_min;
        document.getElementById('produit-stock-max').value = produit.stock_max;
        document.getElementById('produit-emplacement').value = produit.emplacement || '';
        
        toggleModal('modal-produit');
    }
    
    async function deleteProduit(id) {
        if (!confirm('Voulez-vous vraiment supprimer ce produit?')) return;
        
        try {
            const response = await fetch(`/api/produits/${id}`, {method: 'DELETE'});
            if (response.ok) {
                loadProduits();
                alert('‚úÖ Produit supprim√©');
            }
        } catch (error) {
            alert('‚ùå Erreur de suppression');
        }
    }
    
    function filtrerProduits() {
        loadProduits();
    }
    
    async function exporterProduits() {
        window.location.href = '/api/export/produits/excel';
    }
    
    // Recherche en temps r√©el
    document.getElementById('search-produit').addEventListener('input', () => {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(loadProduits, 500);
    });
    
    // Initialisation
    loadProduits();
    loadCategories();
    loadFournisseurs();
</script>
{% endblock %}